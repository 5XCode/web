<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الصفحة الرئيسية - نظام التحميل</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1>نظام التحميل</h1>
            <div class="user-info">
                <span id="userName"></span>
                <button id="logoutBtn" class="btn-secondary">تسجيل الخروج</button>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2>إنشاء صفحة تحميل جديدة</h2>
            <form id="linkForm">
                <input type="url" id="mediafireLink" placeholder="أدخل رابط MediaFire" required>
                <button type="submit" class="btn-primary">فحص الرابط وإنشاء الصفحة</button>
            </form>
            <div id="message" class="message"></div>
            <div id="loading" class="loading" style="display: none;">جاري فحص الرابط...</div>
        </div>

        <div class="card">
            <h2>صفحاتك المنشأة</h2>
            <div id="userLinks" class="links-list">
                <!-- سيتم ملء هذا القسم بالصفحات المنشأة -->
            </div>
        </div>
    </main>

    <script>
        let currentUser = null;

        // التحقق من تسجيل الدخول
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'google.html';
            } else {
                currentUser = user;
                loadUserData();
                loadUserPages();
            }
        });

        // تحميل بيانات المستخدم
        function loadUserData() {
            database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    document.getElementById('userName').textContent = `مرحباً، ${userData.name || userData.displayName || 'مستخدم'}`;
                }
            });
        }

        // معالج تسجيل الخروج
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'google.html';
            });
        });

        // معالج إرسال النموذج
        document.getElementById('linkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const mediafireLink = document.getElementById('mediafireLink').value.trim();
            const messageDiv = document.getElementById('message');
            const loadingDiv = document.getElementById('loading');
            
            if (!mediafireLink) {
                messageDiv.textContent = 'يرجى إدخال رابط MediaFire';
                return;
            }
            
            // التحقق من صحة الرابط
            if (!mediafireLink.includes('mediafire.com')) {
                messageDiv.textContent = 'يرجى إدخال رابط MediaFire صحيح';
                return;
            }
            
            messageDiv.textContent = '';
            loadingDiv.style.display = 'block';
            
            try {
                // فحص الرابط باستخدام API
                const apiUrl = `https://script.google.com/macros/s/AKfycbzlpPlYUeDgsaq0Gb6A6Yxj78E0E7LZbQ3en6hIhIvPrax1URjCeIZ2ptV1mrYlYahC5w/exec?url=${encodeURIComponent(mediafireLink)}`;
                const response = await fetch(apiUrl);
                const result = await response.text();
                
                if (result.includes('发生错误，请联系开发者 KIMO')) {
                    messageDiv.textContent = 'رابط MediaFire غير صالح';
                } else {
                    // إنشاء صفحة جديدة
                    await createNewPage(mediafireLink, result);
                    messageDiv.textContent = 'تم إنشاء الصفحة بنجاح!';
                    document.getElementById('mediafireLink').value = '';
                }
            } catch (error) {
                messageDiv.textContent = 'حدث خطأ أثناء فحص الرابط: ' + error.message;
                console.error('Error:', error);
            } finally {
                loadingDiv.style.display = 'none';
            }
        });

        // دالة إنشاء صفحة جديدة
        async function createNewPage(mediafireLink, directLink) {
            const user = auth.currentUser;
            const userData = await database.ref('users/' + user.uid).once('value');
            const userName = userData.val().name || userData.val().displayName || 'مستخدم';
            
            // تنظيف الاسم لإزالة المسافات
            const cleanName = userName.replace(/\s+/g, '');
            
            // إنشاء رمز عشوائي للصفحة
            const randomCode = Math.random().toString(36).substring(2, 10);
            const pageSlug = `${cleanName}-${randomCode}`;
            
            // بيانات الصفحة
            const pageData = {
                original_mediafire: mediafireLink,
                direct_link: directLink,
                page_link: `${window.location.origin}/page.html?slug=${pageSlug}`,
                page_slug: pageSlug,
                views: 0,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            // حفظ في قاعدة البيانات تحت المستخدم
            const userPageRef = database.ref('users/' + user.uid + '/links').push();
            await userPageRef.set(pageData);
            
            // حفظ في قسم الصفحات العام
            await database.ref('pages/' + pageSlug).set({
                owner: user.uid,
                ownerName: userName,
                ...pageData
            });
            
            return pageSlug;
        }

        // دالة تحميل صفحات المستخدم
        function loadUserPages() {
            const user = auth.currentUser;
            if (!user) return;
            
            database.ref('users/' + user.uid + '/links').on('value', (snapshot) => {
                const linksContainer = document.getElementById('userLinks');
                linksContainer.innerHTML = '';
                
                if (!snapshot.exists()) {
                    linksContainer.innerHTML = '<p>لم تقم بإنشاء أي صفحات بعد</p>';
                    return;
                }
                
                const links = snapshot.val();
                Object.keys(links).forEach(key => {
                    const link = links[key];
                    const linkElement = document.createElement('div');
                    linkElement.className = 'link-item';
                    linkElement.innerHTML = `
                        <h3>${link.page_slug}</h3>
                        <p><strong>رابط الصفحة:</strong> <a href="${link.page_link}" target="_blank">${link.page_link}</a></p>
                        <p><strong>الرابط الأصلي:</strong> ${link.original_mediafire}</p>
                        <p><strong>عدد الزيارات:</strong> ${link.views}</p>
                        <a href="${link.page_link}" target="_blank" class="btn-secondary">فتح الصفحة</a>
                    `;
                    linksContainer.appendChild(linkElement);
                });
            });
        }
    </script>
</body>
</html>
